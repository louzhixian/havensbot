# 2026-01-28 Devlog

## Readings Skill 迁移

### 任务
将 `apps/arkcore/src/readings.ts` 迁移到 Skill 架构。

### 技术决策

#### 1. ButtonHandler 扩展
Skill 系统原本只支持 `reactions` 和 `messages` 处理器，但 Readings 功能需要 Button 交互处理（标为已读/未读按钮）。

**决策**: 扩展 Skill 类型系统，新增 `ButtonHandler` 接口：
- `types.ts`: 新增 `ButtonHandler` 接口，使用 `customIdPrefix` 匹配
- `registry.ts`: 新增 `getAllButtonHandlers()` 方法
- `index.ts`: 注册 `interactionCreate` 事件监听器，路由到对应的 ButtonHandler

这种设计保持了与 ReactionHandler、MessageHandler 一致的模式，便于后续迁移其他使用按钮的功能（如 Diary）。

#### 2. LLM Client 实例化策略
原 `readings.ts` 在模块加载时创建 LLM client 并复用。Skill 架构中，`execute` 函数无法访问模块级状态。

**决策**: 在 message handler 的 `execute` 函数中按需创建 LLM client：
```typescript
const config = loadConfig();
const llmClient = createLlmClient(config);
```

权衡：略有性能开销，但保持了 skill 的无状态特性，更易测试和维护。

#### 3. 缓存保持模块级
`bookmarkedMessages` 和 `threadArticleUrls` 两个缓存保持模块级定义，因为：
- 需要跨请求持久化
- Skill 实例不提供生命周期钩子来管理状态
- 这与 voice.skill.ts 中的 `voiceQueue` 模式一致

### 变更文件
- `apps/arkcore/src/skills/types.ts`: 新增 ButtonHandler 类型
- `apps/arkcore/src/skills/registry.ts`: 新增 getAllButtonHandlers
- `apps/arkcore/src/skills/readings.skill.ts`: 新建，包含完整迁移
- `apps/arkcore/src/skills/index.ts`: 导出 readingsSkill
- `apps/arkcore/src/index.ts`: 注册 skill、添加 button handler wiring、注释掉 legacy 调用

### 已知问题
- TypeScript 编译有大量 discord.js 类型错误（pre-existing），但 tsc 仍能生成 JS 输出
- 建议后续升级 discord.js 或修复类型定义
