# 2026-01-28 M2 ç«¯åˆ°ç«¯æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•èŒƒå›´

æ ¹æ® `docs/plans/2026-01-28-m2-skill-migration.md` Task 6ï¼ŒéªŒè¯æ‰€æœ‰ Skill åŒ–åŠŸèƒ½çš„ç«¯åˆ°ç«¯å·¥ä½œæµç¨‹ã€‚

---

## é™æ€ä»£ç åˆ†æç»“æœ

### 1. âœ… æ–° Guild åŠ å…¥ â†’ è‡ªåŠ¨åˆ›å»º GuildSettings

**ä»£ç è·¯å¾„**: `src/onboarding.ts`, `src/guild-settings.ts`

**éªŒè¯ç»“æœ**:
- `registerGuildCreateHandler` åœ¨ `index.ts` ä¸­æ³¨å†Œ âœ…
- `guildCreate` äº‹ä»¶è§¦å‘æ—¶è°ƒç”¨ `getOrCreateGuildSettings(guild.id)` âœ…
- å‘é€æ¬¢è¿æ¶ˆæ¯åˆ° `guild.systemChannel` âœ…
- é»˜è®¤å¯ç”¨ skills: `["digest", "favorites"]` âœ…

**ç»“è®º**: ä»£ç é€»è¾‘æ­£ç¡®ï¼Œéœ€æ‰‹åŠ¨æµ‹è¯•å®é™… Guild åŠ å…¥è¡Œä¸ºã€‚

---

### 2. âœ… /template apply â†’ åˆ›å»ºé¢‘é“ + tags

**ä»£ç è·¯å¾„**: `src/template-service.ts`, `src/commands.ts`

**éªŒè¯ç»“æœ**:
- `/template list` åˆ—å‡ºæ‰€æœ‰æ¨¡æ¿ âœ…
- `/template apply` è°ƒç”¨ `applyTemplate()` å‡½æ•° âœ…
- `applyTemplate()` å®ç°:
  - åˆ›å»º categories âœ…
  - åˆ›å»º channels (text/forum/voice/announcement) âœ…
  - è®¾ç½® forum availableTags âœ…
  - è®¾ç½® ChannelConfig (role æ˜ å°„) âœ…
  - åº”ç”¨ guildSettings (timezone, locale, enabledSkills) âœ…
- builtin template `havens-default` åœ¨å¯åŠ¨æ—¶ seed âœ…

**Forum Tags é…ç½®**:
```typescript
availableTags: [
  { name: "Digesting", emoji: "ğŸ“Š" },
  { name: "Complete", emoji: "âœ…" },
]
```

**ç»“è®º**: ä»£ç å®Œæ•´ï¼Œéœ€æ‰‹åŠ¨æµ‹è¯• Discord API è°ƒç”¨æ˜¯å¦æˆåŠŸã€‚

---

### 3. âœ… /skills enable/disable â†’ æ­£ç¡®å¼€å…³åŠŸèƒ½

**ä»£ç è·¯å¾„**: `src/commands.ts`, `src/guild-settings.ts`

**éªŒè¯ç»“æœ**:
- `/skills list` æ˜¾ç¤ºæ‰€æœ‰ skills åŠå…¶çŠ¶æ€ âœ…
- `/skills enable <skill>`:
  - æ£€æŸ¥ skill æ˜¯å¦å­˜åœ¨ âœ…
  - æ£€æŸ¥ tier æƒé™ (premium skills éœ€è¦ premium tier) âœ…
  - è°ƒç”¨ `enableSkill(guildId, skillId)` âœ…
- `/skills disable <skill>`:
  - æ£€æŸ¥ skill æ˜¯å¦å­˜åœ¨ âœ…
  - è°ƒç”¨ `disableSkill(guildId, skillId)` âœ…

**Tier æ£€æŸ¥é€»è¾‘**:
```typescript
canUseSkill(skill: Skill, guildTier: string): boolean {
  if (skill.tier === "free") return true;
  return guildTier === "premium";
}
```

**ç»“è®º**: ä»£ç é€»è¾‘æ­£ç¡®ï¼Œå¯é€šè¿‡å‘½ä»¤æµ‹è¯•éªŒè¯ã€‚

---

### 4. âœ… Digest cron â†’ æŒ‰ Guild é…ç½®æ‰§è¡Œ

**ä»£ç è·¯å¾„**: `src/scheduler.ts`, `src/skills/digest.skill.ts`

**éªŒè¯ç»“æœ**:
- `digestSkill` å®šä¹‰ cron job:
  ```typescript
  const digestCronJob: SkillCronJob = {
    id: "digest-daily",
    defaultCron: "0 9 * * *",
    configKey: "digestCron",
    execute: runDigestForGuild,
  };
  ```
- `runSkillCronJobs()` æ¯åˆ†é’Ÿæ‰§è¡Œ:
  - è·å–æ‰€æœ‰ guild settings âœ…
  - æ£€æŸ¥ skill æ˜¯å¦å¯ç”¨ âœ…
  - æ£€æŸ¥ cron æ˜¯å¦åŒ¹é…å½“å‰æ—¶é—´ (è€ƒè™‘ timezone) âœ…
  - æ‰§è¡Œ skill cron job âœ…
- å¤šç§Ÿæˆ·: æ¯ä¸ª guild ç‹¬ç«‹é…ç½® `digestCron` âœ…

**ç»“è®º**: ä»£ç é€»è¾‘æ­£ç¡®ï¼Œå¯é€šè¿‡ä¿®æ”¹ cron æ—¶é—´æµ‹è¯•ã€‚

---

### 5. âœ… Favorites (â¤ï¸) â†’ è½¬å‘åˆ°æ”¶è—é¢‘é“

**ä»£ç è·¯å¾„**: `src/skills/favorites.skill.ts`

**éªŒè¯ç»“æœ**:
- `favoritesSkill` æ³¨å†Œ reaction handler:
  ```typescript
  reactions: [heartReactionHandler, eyesReactionHandler]
  ```
- `heartReactionHandler`:
  - emoji: `["â¤", "â™¥"]` âœ…
  - è·å– `favorites` channel config âœ…
  - é˜²æ­¢é‡å¤è½¬å‘ (`wasForwarded` cache) âœ…
  - è°ƒç”¨ `forwardMessage()` è½¬å‘æ¶ˆæ¯ âœ…

**ç»“è®º**: ä»£ç é€»è¾‘æ­£ç¡®ï¼Œéœ€æ‰‹åŠ¨æµ‹è¯• reaction è§¦å‘ã€‚

---

### 6. âœ… Deep Dive (ğŸ‘€) â†’ LLM åˆ†æ + å¸–å­

**ä»£ç è·¯å¾„**: `src/skills/favorites.skill.ts`

**éªŒè¯ç»“æœ**:
- `eyesReactionHandler`:
  - emoji: `["ğŸ‘€"]` âœ…
  - è·å– `deep_dive_output` channel config âœ…
  - æå– item URL âœ…
  - åˆ›å»º forum post (`createDeepDiveForumPost`) âœ…
  - è°ƒç”¨ `generateDeepDive()` ç”Ÿæˆ LLM åˆ†æ âœ…
  - å‘é€åˆ†æç»“æœåˆ° thread âœ…

**ç»“è®º**: ä»£ç é€»è¾‘æ­£ç¡®ï¼Œéœ€æ‰‹åŠ¨æµ‹è¯• + ç¡®ä¿ LLM é…ç½®æ­£ç¡®ã€‚

---

### 7. âœ… Voice â†’ è¯­éŸ³è½¬æ–‡å­—

**ä»£ç è·¯å¾„**: `src/skills/voice.skill.ts`

**éªŒè¯ç»“æœ**:
- `voiceSkill` å®šä¹‰:
  ```typescript
  id: "voice",
  tier: "free",
  messages: [voiceMessageHandler],
  reactions: [retryReactionHandler],
  channelRoles: ["editorial"],
  ```
- `voiceMessageHandler`:
  - æ£€æŸ¥ `channelRole: "editorial"` âœ…
  - è¿‡æ»¤ audio attachments âœ…
  - æ·»åŠ  reaction çŠ¶æ€æŒ‡ç¤º (ğŸ•â†’â³â†’âœ…/âŒ) âœ…
  - è°ƒç”¨ `transcribe()` (Whisper API) âœ…
  - è°ƒç”¨ `polishTranscript()` (LLM æ¶¦è‰²) âœ…
  - åˆ›å»º thread å‘é€ç»“æœ âœ…
- é‡è¯•æœºåˆ¶: `retryReactionHandler` å¤„ç† ğŸ”„ emoji âœ…

**å‰ç½®æ¡ä»¶**: `config.voiceToTextEnabled` å’Œ `config.whisperApiUrl` å¿…é¡»é…ç½®ã€‚

**ç»“è®º**: ä»£ç å®Œæ•´ï¼Œéœ€æ‰‹åŠ¨æµ‹è¯•è¯­éŸ³æ¶ˆæ¯å¤„ç†ã€‚

---

### 8. âœ… Readings â†’ é˜…è¯»ç®¡ç†

**ä»£ç è·¯å¾„**: `src/skills/readings.skill.ts`

**éªŒè¯ç»“æœ**:
- `readingsSkill` å®šä¹‰:
  ```typescript
  id: "readings",
  tier: "free",
  reactions: [bookmarkReactionHandler],
  buttons: [toggleButtonHandler],
  messages: [readingsQAHandler],
  channelRoles: ["readings"],
  ```
- `bookmarkReactionHandler`:
  - emoji: `ğŸ”–` âœ…
  - è·å– `readings` forum config âœ…
  - åˆ›å»º forum post âœ…
  - è®¾ç½® "unread" tag âœ…
  - å‘é€åŸæ¶ˆæ¯é“¾æ¥å’Œ toggle button âœ…
- `toggleButtonHandler`:
  - åˆ‡æ¢ unread/read tags âœ…
  - æ›´æ–° button çŠ¶æ€ âœ…
- `readingsQAHandler`:
  - åœ¨ readings thread ä¸­å“åº”ç”¨æˆ·é—®é¢˜ âœ…
  - è°ƒç”¨ LLM ç”Ÿæˆå›ç­” âœ…

**ç»“è®º**: ä»£ç å®Œæ•´ï¼Œéœ€æ‰‹åŠ¨æµ‹è¯•ä¹¦ç­¾å’Œ Q&A åŠŸèƒ½ã€‚

---

### 9. âœ… Editorial â†’ ç¿»è¯‘è®¨è®º

**ä»£ç è·¯å¾„**: `src/skills/editorial.skill.ts`

**éªŒè¯ç»“æœ**:
- `editorialSkill` å®šä¹‰:
  ```typescript
  id: "editorial",
  tier: "free",
  messages: [editorialChannelHandler, editorialThreadHandler],
  channelRoles: ["editorial"],
  ```
- `editorialChannelHandler`:
  - è½¬å‘æ¶ˆæ¯ â†’ åˆ›å»º "åˆ›ä½œè®¨è®º" thread âœ…
  - URL/æ–‡æœ¬æ¶ˆæ¯ â†’ åˆ›å»º "ç¿»è¯‘" thread âœ…
  - æ”¯æŒ GitHub raw URL å’Œç½‘é¡µæŠ“å– âœ…
  - åˆ†å—ç¿»è¯‘é•¿æ–‡ âœ…
- `editorialThreadHandler`:
  - åœ¨è®¨è®º thread ä¸­å“åº”ç”¨æˆ·æ¶ˆæ¯ âœ…
  - æ„å»ºå¯¹è¯å†å² âœ…
  - è°ƒç”¨ LLM ç”Ÿæˆåˆ›ä½œå†…å®¹ âœ…

**ç»“è®º**: ä»£ç å®Œæ•´ï¼Œéœ€æ‰‹åŠ¨æµ‹è¯•ç¿»è¯‘å’Œè®¨è®ºåŠŸèƒ½ã€‚

---

### 10. âœ… Diary â†’ å®šæ—¶åˆ›å»ºæ—¥è®°

**ä»£ç è·¯å¾„**: `src/skills/diary.skill.ts`

**éªŒè¯ç»“æœ**:
- `diarySkill` å®šä¹‰:
  ```typescript
  id: "diary",
  tier: "premium",  // æ³¨æ„: premium åŠŸèƒ½
  messages: [diaryMessageHandler],
  buttons: [diaryStartButtonHandler, diaryEndButtonHandler],
  cron: [dailyDiaryPostCron, diaryTimeoutCheckCron],
  channelRoles: ["diary"],
  ```
- `dailyDiaryPostCron`:
  - defaultCron: `"0 6 * * *"` (æ¯å¤© 6:00) âœ…
  - è°ƒç”¨ `createDailyDiaryPost()` âœ…
- `diaryTimeoutCheckCron`:
  - æ¯ 5 åˆ†é’Ÿæ£€æŸ¥è¶…æ—¶ session âœ…
- Button handlers:
  - å¼€å§‹æ—¥è®° session âœ…
  - ç»“æŸæ—¥è®° session âœ…
- Message handler:
  - åœ¨æ´»è·ƒ diary thread ä¸­å“åº”ç”¨æˆ·æ¶ˆæ¯ âœ…
  - è°ƒç”¨ LLM ç”Ÿæˆå¯¹è¯å›å¤ âœ…

**ç»“è®º**: ä»£ç å®Œæ•´ï¼Œéœ€ premium tier æ‰èƒ½ä½¿ç”¨ï¼Œéœ€æ‰‹åŠ¨æµ‹è¯•ã€‚

---

## æ¶æ„éªŒè¯æ€»ç»“

### Skill æ³¨å†Œé“¾

```
index.ts
  â†“ åˆ›å»º SkillRegistry
  â†“ registry.register(diarySkill)
  â†“ registry.register(digestSkill)
  â†“ registry.register(editorialSkill)
  â†“ registry.register(favoritesSkill)
  â†“ registry.register(readingsSkill)
  â†“ registry.register(voiceSkill)
  â†“
  â†“ client.on("messageReactionAdd")
  â†“   â†’ registry.getAllReactionHandlers()
  â†“   â†’ æ£€æŸ¥ skill æ˜¯å¦å¯ç”¨
  â†“   â†’ è°ƒç”¨ handler.execute()
  â†“
  â†“ client.on("messageCreate")
  â†“   â†’ registry.getAllMessageHandlers()
  â†“   â†’ æ£€æŸ¥ skill æ˜¯å¦å¯ç”¨
  â†“   â†’ æ£€æŸ¥ channelRole åŒ¹é…
  â†“   â†’ è°ƒç”¨ handler.execute()
  â†“
  â†“ client.on("interactionCreate") [button]
      â†’ registry.getAllButtonHandlers()
      â†’ æ£€æŸ¥ skill æ˜¯å¦å¯ç”¨
      â†’ æ£€æŸ¥ customIdPrefix åŒ¹é…
      â†’ è°ƒç”¨ handler.execute()
```

### å¤šç§Ÿæˆ·éš”ç¦»

- æ¯ä¸ª Guild æœ‰ç‹¬ç«‹çš„ `GuildSettings` âœ…
- Skill å¯ç”¨çŠ¶æ€æŒ‰ Guild å­˜å‚¨ (`enabledSkills[]`) âœ…
- Cron æŒ‰ Guild timezone æ‰§è¡Œ âœ…
- Channel é…ç½®æŒ‰ Guild å­˜å‚¨ (`ChannelConfig`) âœ…

---

## æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

### å‰ç½®æ¡ä»¶

1. éƒ¨ç½² Haven bot åˆ°æµ‹è¯•æœåŠ¡å™¨
2. ç¡®ä¿ LLM API é…ç½®æ­£ç¡® (`.env`)
3. ç¡®ä¿ Whisper API é…ç½®æ­£ç¡® (å¦‚éœ€æµ‹è¯• Voice)

### æµ‹è¯•ç”¨ä¾‹

| # | åŠŸèƒ½ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ |
|---|------|----------|----------|
| 1 | Guild Join | é‚€è¯· bot åˆ°æ–°æœåŠ¡å™¨ | åˆ›å»º GuildSettings + å‘é€æ¬¢è¿æ¶ˆæ¯ |
| 2 | Template Apply | `/template apply havens-default` | åˆ›å»ºåˆ†ç±»ã€é¢‘é“ã€tags |
| 3 | Skills Enable | `/skills enable readings` | å¯ç”¨ readings skill |
| 4 | Skills Disable | `/skills disable readings` | ç¦ç”¨ readings skill |
| 5 | Digest | `/digest run` æˆ–ç­‰å¾… cron | ç”Ÿæˆæ‘˜è¦å¸–å­ |
| 6 | Favorites | å¯¹æ¶ˆæ¯æ·»åŠ  â¤ï¸ | è½¬å‘åˆ° #favorites |
| 7 | Deep Dive | å¯¹æ¶ˆæ¯æ·»åŠ  ğŸ‘€ | åˆ›å»º forum post + LLM åˆ†æ |
| 8 | Voice | åœ¨ editorial é¢‘é“å‘é€è¯­éŸ³ | è½¬æ–‡å­— + æ¶¦è‰² |
| 9 | Readings | å¯¹æ¶ˆæ¯æ·»åŠ  ğŸ”– | åˆ›å»º reading post + toggle button |
| 10 | Editorial | åœ¨ editorial é¢‘é“å‘é€ URL | åˆ›å»ºç¿»è¯‘ thread |
| 11 | Diary | ç‚¹å‡»æ—¥è®°å¸–å­çš„"å¼€å§‹æ—¥è®°"æŒ‰é’® | å¼€å§‹å¯¹è¯ session |

---

## å‘ç°çš„é—®é¢˜

æš‚æ— ä»£ç çº§é—®é¢˜ï¼Œæ‰€æœ‰åŠŸèƒ½çš„é™æ€åˆ†æå‡é€šè¿‡ã€‚

---

## å»ºè®®

1. **æ·»åŠ é›†æˆæµ‹è¯•**: ä½¿ç”¨ mock Discord client æµ‹è¯• handler æ³¨å†Œå’Œè§¦å‘
2. **æ·»åŠ å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥ skill cron æ˜¯å¦æ­£å¸¸æ‰§è¡Œ
3. **ç›‘æ§**: æ·»åŠ  metrics è·Ÿè¸ªæ¯ä¸ª skill çš„æ‰§è¡Œæ¬¡æ•°å’Œé”™è¯¯ç‡

---

_æµ‹è¯•å®Œæˆäº 2026-01-28_
